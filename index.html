<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe èªéŸ³ç­†è¨˜æœ¬ v1.9.1 (éŸ³è¨Šè·¯ç”±å¢å¼·ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .mic-active { animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @keyframes slide-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .msg-card { animation: slide-in 0.3s ease-out forwards; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        
        .debug-line { font-family: monospace; border-bottom: 1px solid #334155; padding: 2px 0; word-break: break-all; }
        .log-raw { color: #94a3b8; }
        .log-final { color: #34d399; font-weight: bold; }
        .log-ai { color: #60a5fa; }
        .log-error { color: #f87171; }
        .log-sys { color: #fbbf24; }

        .mode-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 0.7rem top 50%;
            background-size: 0.65rem auto;
        }
        
        .prose h1 { font-size: 1.5em; font-weight: bold; margin-bottom: 0.5em; color: #1e293b; }
        .prose h2 { font-size: 1.25em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #334155; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.25em; }
        .prose strong { color: #0f172a; font-weight: 600; }

        #audio-visualizer {
            width: 100px;
            height: 30px;
            border-radius: 4px;
            background-color: #f1f5f9;
        }
        
        .audio-status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .audio-status-good { background-color: #10b981; }
        .audio-status-warning { background-color: #f59e0b; }
        .audio-status-error { background-color: #ef4444; }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        .blink { animation: blink 1s infinite; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-slate-50">

    <!-- Toast -->
    <div id="toast-container" class="fixed top-4 left-0 right-0 z-[90] flex justify-center pointer-events-none">
        <div id="toast" class="transform -translate-y-full opacity-0 transition-all duration-300 bg-white border border-red-100 text-red-600 px-6 py-3 rounded-full shadow-lg flex items-center gap-3 pointer-events-auto">
            <i id="toast-icon" class="fa-solid fa-circle-exclamation"></i>
            <span id="toast-msg" class="font-medium text-sm"></span>
        </div>
    </div>

    <!-- Debug Console -->
    <div id="debug-panel" class="fixed bottom-0 left-0 right-0 h-48 bg-slate-900/95 text-xs p-4 overflow-y-auto z-[80] hidden border-t border-slate-700 shadow-2xl transition-transform duration-300">
        <div class="flex justify-between items-center mb-2 sticky top-0 bg-slate-900/95 pb-2 border-b border-slate-700">
            <span class="font-bold text-white flex items-center gap-2">
                <i class="fa-solid fa-terminal text-green-400"></i> SYSTEM LOG
            </span>
            <div class="flex gap-2">
                <button onclick="copyDebugLog()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-xs transition-colors flex items-center gap-1">
                    <i class="fa-regular fa-copy"></i> Copy Log
                </button>
                <button onclick="clearDebugLog()" class="text-slate-400 hover:text-white px-2">Clear</button>
                <button onclick="toggleDebugPanel()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
        </div>
        <div id="debug-content" class="space-y-1 font-mono select-text cursor-text"></div>
    </div>

    <!-- Summary Modal -->
    <div id="summary-modal" class="fixed inset-0 z-[70] bg-black/40 backdrop-blur-sm hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl h-[85vh] flex flex-col scale-95 transition-transform duration-300 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center">
                        <i class="fa-solid fa-wand-magic-sparkles text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800">AI ç¸½çµå·¥åŠ</h3>
                        <p class="text-xs text-slate-500">é¸æ“‡æç¤ºè©æ¨¡æ¿æˆ–è‡ªå®šç¾©æŒ‡ä»¤</p>
                    </div>
                </div>
                <button onclick="toggleSummaryModal()" class="w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center text-slate-500 transition-colors">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
                <div class="w-full md:w-1/3 border-r border-slate-100 bg-slate-50 flex flex-col">
                    <div class="p-3 border-b border-slate-100 flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Templates</span>
                        <button onclick="addNewPrompt()" class="text-indigo-600 hover:text-indigo-800 text-xs font-bold px-2 py-1 rounded hover:bg-indigo-50 transition-colors">
                            <i class="fa-solid fa-plus mr-1"></i>æ–°å¢
                        </button>
                    </div>
                    <div id="prompt-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                </div>
                <div class="flex-1 flex flex-col bg-white h-full overflow-hidden">
                    <div class="p-4 border-b border-slate-100">
                        <div class="mb-2 flex justify-between items-center">
                            <input type="text" id="prompt-title" class="text-sm font-bold text-slate-800 w-2/3 border-none focus:ring-0 p-0" placeholder="æç¤ºè©åç¨±...">
                            <div class="flex gap-2">
                                <button onclick="saveCurrentPrompt()" class="text-xs text-emerald-600 hover:bg-emerald-50 px-2 py-1 rounded transition-colors" title="å„²å­˜è®Šæ›´"><i class="fa-solid fa-save"></i> å„²å­˜</button>
                                <button onclick="deleteCurrentPrompt()" class="text-xs text-red-400 hover:bg-red-50 px-2 py-1 rounded transition-colors" title="åˆªé™¤"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                        <textarea id="prompt-content" class="w-full h-24 text-sm text-slate-600 border border-slate-200 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none" placeholder="è¼¸å…¥çµ¦ AI çš„æŒ‡ä»¤..."></textarea>
                        <div class="mt-3 flex justify-end">
                            <button onclick="generateSummary()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md shadow-indigo-200 transition-all flex items-center gap-2">
                                <i class="fa-solid fa-play"></i> é–‹å§‹ç”Ÿæˆç¸½çµ
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 bg-slate-50/30 relative">
                        <div id="summary-loading" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-10">
                            <div class="w-10 h-10 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-3"></div>
                            <p class="text-sm text-indigo-600 font-bold animate-pulse">AI æ­£åœ¨é–±è®€æ‚¨çš„ç­†è¨˜...</p>
                        </div>
                        <div id="summary-result" class="prose prose-sm max-w-none text-slate-700">
                            <div class="text-center text-slate-400 mt-10">
                                <i class="fa-regular fa-file-lines text-4xl mb-3 opacity-30"></i>
                                <p>é¸æ“‡å·¦å´æ¨¡æ¿ä¸¦é»æ“Šç”Ÿæˆï¼Œ<br>AI å°‡ç‚ºæ‚¨æ•´ç†æœ¬æ¬¡ç´€éŒ„çš„é‡é»ã€‚</p>
                            </div>
                        </div>
                    </div>
                    <div id="summary-actions" class="p-3 border-t border-slate-100 bg-white flex justify-end hidden">
                        <button onclick="copySummary()" class="text-slate-500 hover:text-indigo-600 px-3 py-1.5 rounded text-sm transition-colors flex items-center gap-2">
                            <i class="fa-regular fa-copy"></i> è¤‡è£½çµæœ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio Help Modal -->
    <div id="audio-help-modal" class="fixed inset-0 z-[70] bg-black/40 backdrop-blur-sm hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 scale-95 transition-transform duration-300 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-slate-800 mb-4"><i class="fa-solid fa-headphones text-indigo-500 mr-2"></i>æ“·å–ç³»çµ±è²éŸ³</h3>
            <div class="space-y-4 text-sm text-slate-600 leading-relaxed">
                <p>ç€è¦½å™¨é è¨­åªèƒ½è½è¦‹ã€Œéº¥å…‹é¢¨ã€çš„è²éŸ³ã€‚è‹¥è¦éŒ„è£½ç·šä¸Šæœƒè­°æˆ–å½±ç‰‡ï¼Œè«‹ä¾ç…§ç³»çµ±è¨­å®šï¼š</p>
                
                <!-- Red Warning Box -->
                <div class="bg-red-50 border-2 border-red-300 p-4 rounded-xl">
                    <h4 class="font-bold text-red-700 mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        é—œéµæ­¥é©Ÿ (å¿…é ˆå®Œæˆï¼)
                    </h4>
                    <ol class="list-decimal pl-4 space-y-1 text-red-700">
                        <li>åœ¨ Chrome ç¶²å€åˆ—è¼¸å…¥ï¼š<br><code class="bg-red-100 px-2 py-0.5 rounded text-xs">chrome://settings/content/microphone</code></li>
                        <li>å°‡é è¨­éº¥å…‹é¢¨æ”¹ç‚º <strong>Stereo Mix</strong></li>
                        <li>é‡æ–°æ•´ç†æœ¬é é¢</li>
                    </ol>
                </div>
                
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                    <h4 class="font-bold text-slate-800 mb-1">ğŸªŸ Windows ä½¿ç”¨è€…</h4>
                    <ol class="list-decimal pl-4 space-y-1">
                        <li>å³éµé»æ“ŠéŸ³é‡åœ–ç¤º >ã€Œè²éŸ³è¨­å®šã€</li>
                        <li>é€²å…¥ã€ŒéŸ³æ•ˆæ§åˆ¶é¢æ¿ã€>ã€ŒéŒ„è£½ã€æ¨™ç±¤</li>
                        <li>å³éµç©ºç™½è™• > å‹¾é¸ã€Œé¡¯ç¤ºå·²åœç”¨çš„è£ç½®ã€</li>
                        <li>æ‰¾åˆ° <strong>Stereo Mix (ç«‹é«”è²æ··éŸ³)</strong> ä¸¦å•Ÿç”¨å®ƒ</li>
                    </ol>
                </div>
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                    <h4 class="font-bold text-slate-800 mb-1">ğŸ Mac ä½¿ç”¨è€…</h4>
                    <p>Mac åŸç”Ÿä¸æ”¯æ´å…§éŒ„ã€‚è«‹å®‰è£å…è²»çš„è™›æ“¬éŸ³è¨Šé©…å‹•ï¼š</p>
                    <ul class="list-disc pl-4 mt-2">
                        <li><a href="https://github.com/ExistentialAudio/BlackHole" target="_blank" class="text-indigo-600 underline hover:text-indigo-800">BlackHole (æ¨è–¦)</a></li>
                        <li><a href="https://vb-audio.com/Cable/" target="_blank" class="text-indigo-600 underline hover:text-indigo-800">VB-Cable</a></li>
                    </ul>
                </div>
                
                <!-- Wave Detection Guide -->
                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-200">
                    <h4 class="font-bold text-indigo-800 mb-1">ğŸ“Š å¦‚ä½•ç¢ºèªéŸ³è¨Šæ­£å¸¸ï¼Ÿ</h4>
                    <p class="text-indigo-700">è«‹è§€å¯Ÿé é¢é ‚éƒ¨çš„<strong>æ³¢å½¢åœ–</strong>ï¼š</p>
                    <ul class="list-disc pl-4 mt-1 text-indigo-700">
                        <li>æœ‰æ³¢å‹• = éŸ³è¨Šæ­£å¸¸æ¥æ”¶ä¸­</li>
                        <li>ç„¡æ³¢å‹• = è£ç½®å¯èƒ½æœªæ­£ç¢ºè¨­å®š</li>
                        <li>å¯ä½¿ç”¨è¨­å®šä¸­çš„ã€Œæ¸¬è©¦éŸ³è¨Šè¨Šè™Ÿã€æŒ‰éˆ•é©—è­‰</li>
                    </ul>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="toggleAudioHelp()" class="px-5 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-bold transition-all">çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

    <!-- Clear Modal -->
    <div id="clear-modal" class="fixed inset-0 z-[70] bg-black/40 backdrop-blur-sm hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 scale-95 transition-transform duration-300">
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                    <i class="fa-regular fa-trash-can text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">ç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿ</h3>
                <p class="text-sm text-slate-500">ç•«é¢ä¸Šçš„æ‰€æœ‰ç­†è¨˜å°‡æœƒè¢«ç§»é™¤ä¸”ç„¡æ³•å¾©åŸã€‚</p>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleClearModal()" class="flex-1 px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl hover:bg-slate-200 font-medium transition-colors">å–æ¶ˆ</button>
                <button onclick="performClear()" class="flex-1 px-4 py-2.5 bg-red-500 text-white rounded-xl hover:bg-red-600 font-medium transition-colors shadow-md shadow-red-200">ç¢ºèªæ¸…ç©º</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800">API è¨­å®š</h3>
                <button onclick="toggleSettings()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Google Gemini API Key</label>
                    <input type="password" id="api-key-input" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all text-slate-700" placeholder="AI Studio Key (ä»¥ AIza é–‹é ­)">
                </div>

                <!-- Audio Input Select (New) -->
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">
                        ğŸ™ï¸ éŸ³è¨Šè¼¸å…¥è£ç½® (Audio Input)
                        <span id="audio-status-indicator" class="audio-status-indicator audio-status-warning" title="éŸ³è¨Šç‹€æ…‹"></span>
                        <span id="audio-status-text" class="text-xs text-slate-500">æœªæ¸¬è©¦</span>
                    </label>
                    <select id="audio-source-select" class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all text-slate-700 text-sm bg-white">
                        <option value="default">é è¨­è£ç½® (Default)</option>
                    </select>
                    <div class="mt-2 flex justify-between items-center">
                        <p class="text-xs text-slate-500">
                            <i class="fa-solid fa-circle-info mr-1"></i>
                            åˆ‡æ›å¾Œè«‹è§€å¯Ÿä¸Šæ–¹æ³¢å½¢åœ–ã€‚
                        </p>
                        <button onclick="testAudioInput()" class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg hover:bg-indigo-200 transition-colors font-bold flex items-center gap-1">
                            <i class="fa-solid fa-wave-square"></i>
                            æ¸¬è©¦éŸ³è¨Šè¨Šè™Ÿ
                        </button>
                    </div>
                </div>
                
                <div class="bg-indigo-50 p-4 rounded-xl flex items-start gap-3">
                    <i class="fa-solid fa-users-viewfinder text-indigo-600 mt-1"></i>
                    <div>
                        <h4 class="text-sm font-bold text-indigo-800 mb-1">é›™æ¨¡å¼å¼•æ“ V1.9.1</h4>
                        <p class="text-xs text-indigo-700 leading-relaxed">æ–°å¢éŸ³è¨Šè·¯ç”±å¢å¼·ã€è‡ªå‹•é‡è©¦æ©Ÿåˆ¶ã€éŸ³è¨Šæ¸¬è©¦åŠŸèƒ½ã€‚</p>
                    </div>
                </div>

                <!-- AI Translate Toggle -->
                <div class="flex items-center justify-between border-t border-slate-100 pt-4 mt-4">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-language text-slate-400"></i>
                        <span class="text-sm font-bold text-slate-700">AI ç¿»è­¯ (åŒæ­¥æ§åˆ¶)</span>
                    </div>
                    <div class="relative inline-block w-10 align-middle select-none">
                        <input type="checkbox" id="ai-toggle-settings" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300 right-5"/>
                        <label for="ai-toggle-settings" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300"></label>
                    </div>
                </div>

                <div class="flex items-center justify-between border-t border-slate-100 pt-4 mt-4">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-bug text-slate-400"></i>
                        <span class="text-sm font-bold text-slate-700">Debug æ¨¡å¼</span>
                    </div>
                    <div class="relative inline-block w-10 align-middle select-none">
                        <input type="checkbox" id="debug-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300 right-5"/>
                        <label for="debug-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300"></label>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button onclick="saveSettings()" class="px-6 py-2.5 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 font-bold transition-all shadow-md hover:shadow-lg active:scale-95">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass-panel z-10 w-full px-4 md:px-8 py-3 flex items-center justify-between shrink-0 h-16 md:h-20 gap-4">
        <div class="flex items-center gap-3 shrink-0">
            <div class="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center text-white shadow-emerald-200 shadow-lg transition-colors" id="app-logo">
                <i class="fa-solid fa-microphone-lines text-lg"></i>
            </div>
            <div class="hidden md:block">
                <h1 class="text-lg font-bold text-slate-800">Vibe Voice</h1>
                <div class="relative">
                    <select id="mode-select" onchange="changeMode(this.value)" class="mode-select appearance-none bg-transparent text-[10px] md:text-xs font-bold text-emerald-600 tracking-wider uppercase pr-6 cursor-pointer focus:outline-none">
                        <option value="lecture">Lecture Mode (ä¸Šèª²)</option>
                        <option value="meeting">Meeting Mode (æœƒè­°)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Visualizer Area -->
        <div class="flex-1 flex justify-center items-center h-full px-2">
            <canvas id="audio-visualizer" class="hidden md:block w-32 h-8"></canvas>
        </div>

        <!-- Tools -->
        <div class="flex items-center gap-2 md:gap-3 shrink-0">
            <div class="flex items-center gap-2 mr-2 hidden lg:flex">
                <span class="text-xs font-bold text-slate-500">AI ç¿»è­¯</span>
                <div class="relative inline-block w-10 align-middle select-none">
                    <input type="checkbox" id="ai-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300 right-5"/>
                    <label for="ai-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300"></label>
                </div>
            </div>
            
            <button onclick="toggleAudioHelp()" class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 transition-all flex items-center justify-center" title="ç³»çµ±è²éŸ³è¨­å®š">
                <i class="fa-solid fa-headphones"></i>
            </button>

            <button onclick="toggleSummaryModal()" class="w-9 h-9 rounded-full bg-indigo-50 border border-indigo-200 text-indigo-600 hover:bg-indigo-100 transition-all flex items-center justify-center shadow-sm" title="AI ç¸½çµ">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
            </button>
            
            <button onclick="toggleSettings()" class="w-9 h-9 rounded-full bg-white border border-slate-200 text-slate-500 hover:text-emerald-600 hover:border-emerald-300 transition-all flex items-center justify-center shadow-sm" title="è¨­å®š">
                <i class="fa-solid fa-gear"></i>
            </button>
            
            <button onclick="clearAll()" class="w-9 h-9 rounded-full bg-white border border-slate-200 text-slate-500 hover:text-red-500 hover:border-red-300 transition-all flex items-center justify-center shadow-sm" title="æ¸…ç©º">
                <i class="fa-regular fa-trash-can"></i>
            </button>
        </div>
    </header>

    <!-- Language Bar -->
    <div class="w-full bg-slate-50 border-b border-slate-200 p-2 flex justify-center gap-4">
        <button id="lang-en" onclick="setLanguage('en-US')" class="px-4 py-1 rounded-full text-xs font-bold transition-all bg-white text-emerald-700 shadow-sm border border-slate-200">EN è‹±æ–‡è¼¸å…¥</button>
        <button id="lang-zh" onclick="setLanguage('zh-TW')" class="px-4 py-1 rounded-full text-xs font-bold transition-all text-slate-500 hover:text-slate-700 border border-transparent">ZH ä¸­æ–‡è¼¸å…¥</button>
    </div>

    <!-- Main -->
    <main class="flex-1 w-full max-w-4xl mx-auto p-4 flex flex-col relative overflow-hidden pb-56">
        <div id="welcome-screen" class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 z-0 pointer-events-none">
            <i class="fa-solid fa-chalkboard-user text-6xl mb-4 opacity-50 transition-opacity" id="welcome-icon"></i>
            <p class="text-lg font-medium" id="welcome-text">æº–å‚™å¥½ä¸Šèª²äº†å—ï¼Ÿ</p>
            <p class="text-sm opacity-70">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œå³æ™‚æ•æ‰æ¯ä¸€å¥é‡é»</p>
        </div>
        <div id="message-container" class="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-32 px-2 z-10 scroll-smooth"></div>
        <div id="interim-bar" class="absolute bottom-24 left-4 right-4 bg-slate-900/80 backdrop-blur-md text-white p-4 rounded-2xl shadow-xl transform transition-all duration-300 opacity-0 translate-y-4 z-20">
            <div class="flex justify-between items-end mb-1">
                <p id="interim-text" class="text-lg md:text-xl font-light leading-relaxed flex-1 mr-4">...</p>
                <div class="text-[10px] text-slate-400 font-mono tracking-wider uppercase shrink-0" id="mic-status">Waiting...</div>
            </div>
        </div>
        <div id="mic-container" class="absolute bottom-6 left-0 right-0 flex justify-center z-30 transition-all duration-300 ease-out">
            <button id="mic-btn" onclick="toggleRecognition()" class="group relative w-16 h-16 md:w-20 md:h-20 bg-slate-800 rounded-full text-white shadow-2xl shadow-slate-400/50 flex items-center justify-center transition-all hover:scale-105 hover:bg-slate-700 active:scale-95">
                <i class="fa-solid fa-microphone text-2xl md:text-3xl transition-transform group-hover:scale-110"></i>
                <span class="absolute top-0 right-0 w-4 h-4 bg-red-500 rounded-full border-2 border-white hidden" id="recording-dot"></span>
            </button>
        </div>
    </main>

    <audio id="sfx-start" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="sfx-end" src="https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3"></audio>

    <script>
        // --- Variables ---
        let recognition;
        let isListening = false;
        let currentLang = 'en-US'; 
        let apiKey = localStorage.getItem('vibe_gemini_api_key') || '';
        let isAIEnabled = false;
        let isDebugMode = false;
        let ignoreEnd = false;
        let messageHistory = JSON.parse(localStorage.getItem('vibe_history') || '[]');
        let lastFinalText = '';
        let currentMode = 'lecture';
        let selectedDeviceId = localStorage.getItem('vibe_audio_device') || 'default';
        
        // --- DOM Elements (Declared Global) ---
        let msgContainer;
        let interimBar;
        let interimText;
        let micStatus;
        let micBtn;
        let micContainer;
        let recDot;
        let welcomeScreen;
        let apiKeyInput;
        let settingsModal;
        let clearModal;
        let summaryModal;
        let audioHelpModal;
        let aiToggle;
        let aiToggleSettings;
        let debugToggle;
        let debugPanel;
        let debugContent;
        let modeSelect;
        let appLogo;
        let welcomeIcon;
        let welcomeText;
        let canvas;
        let canvasCtx;
        let audioSelect;

        // --- Other Globals ---
        let lastResultTime = Date.now();
        let pendingInterim = '';
        let lastInterimLength = 0;
        const SILENCE_TIMEOUT = 15000; 
        let silenceInterval = null;
        let audioContext, analyser, microphone, stream;
        let sourceNode, destinationNode; // For audio routing
        let restartAttempts = 0;
        const MAX_RESTART_ATTEMPTS = 5;
        let audioTestInterval = null;
        
        // Audio test constants
        const AUDIO_TEST_DURATION = 20;         // Number of test iterations (500ms each = 10 seconds)
        const AUDIO_SIGNAL_THRESHOLD = 5;        // Minimum average signal level to detect audio
        const NO_SIGNAL_WARNING_COUNT = 10;      // Iterations without signal before warning (5 seconds)
        
        // --- Prompts ---
        let customPrompts = JSON.parse(localStorage.getItem('vibe_prompts') || '[]');
        const defaultPrompts = [
            { id: 'p1', title: 'ğŸ“ æœƒè­°ç´€è¦', content: `è«‹æ ¹æ“šä»¥ä¸‹å…§å®¹ç”Ÿæˆä¸€ä»½å°ˆæ¥­çš„æœƒè­°ç´€è¦ã€‚\næ ¼å¼è¦æ±‚ï¼š\n1. **æœƒè­°ä¸»é¡Œ**\n2. **é—œéµæ±ºç­–**\n3. **å¾…è¾¦äº‹é … (Action Items)**\n4. **è©³ç´°æ‘˜è¦**` },
            { id: 'p2', title: 'ğŸ“ èª²å ‚é‡é»', content: `è«‹å°‡é€™æ®µä¸Šèª²å…§å®¹æ•´ç†æˆå­¸ç¿’ç­†è¨˜ã€‚\næ ¼å¼è¦æ±‚ï¼š\n1. **æ ¸å¿ƒæ¦‚å¿µ**\n2. **åè©è§£é‡‹**\n3. **è©³ç´°ç­†è¨˜**` },
            { id: 'p3', title: 'âœ… å¾…è¾¦æ¸…å–®', content: `è«‹å¿½ç•¥é–’èŠï¼Œåªå¹«æˆ‘æå–å‡ºæ‰€æœ‰éœ€è¦åŸ·è¡Œçš„ä»»å‹™ã€‚\næ ¼å¼ï¼š\n- [ ] ä»»å‹™å…§å®¹ (è² è²¬äºº)` }
        ];
        let allPrompts = [...defaultPrompts, ...customPrompts];
        let currentPromptId = null;

        // --- INITIALIZATION ON LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Assign DOM Elements
            msgContainer = document.getElementById('message-container');
            interimBar = document.getElementById('interim-bar');
            interimText = document.getElementById('interim-text');
            micStatus = document.getElementById('mic-status');
            micBtn = document.getElementById('mic-btn');
            micContainer = document.getElementById('mic-container');
            recDot = document.getElementById('recording-dot');
            welcomeScreen = document.getElementById('welcome-screen');
            apiKeyInput = document.getElementById('api-key-input');
            settingsModal = document.getElementById('settings-modal');
            clearModal = document.getElementById('clear-modal');
            summaryModal = document.getElementById('summary-modal');
            audioHelpModal = document.getElementById('audio-help-modal');
            aiToggle = document.getElementById('ai-toggle');
            aiToggleSettings = document.getElementById('ai-toggle-settings');
            debugToggle = document.getElementById('debug-toggle');
            debugPanel = document.getElementById('debug-panel');
            debugContent = document.getElementById('debug-content');
            modeSelect = document.getElementById('mode-select');
            appLogo = document.getElementById('app-logo');
            welcomeIcon = document.getElementById('welcome-icon');
            welcomeText = document.getElementById('welcome-text');
            canvas = document.getElementById('audio-visualizer');
            canvasCtx = canvas ? canvas.getContext('2d') : null;
            audioSelect = document.getElementById('audio-source-select');

            // 2. Restore Settings
            if(apiKeyInput) apiKeyInput.value = apiKey;
            
            // 3. Attach Listeners
            if(aiToggle) aiToggle.addEventListener('change', (e) => toggleAI(e.target.checked));
            if(aiToggleSettings) aiToggleSettings.addEventListener('change', (e) => toggleAI(e.target.checked));
            if(debugToggle) {
                debugToggle.addEventListener('change', (e) => {
                    isDebugMode = e.target.checked;
                    updateDebugUI();
                });
            }
            
            if(audioSelect) {
                // Load Audio Devices
                getAudioInputs();
                audioSelect.addEventListener('change', (e) => {
                    selectedDeviceId = e.target.value;
                    localStorage.setItem('vibe_audio_device', selectedDeviceId);
                    logDebug(`Audio device changed to: ${e.target.options[e.target.selectedIndex].text}`, "sys");
                    
                    // Restart recognition with new device
                    if(isListening) {
                        stopRecognition();
                        setTimeout(() => {
                            startRecognition();
                        }, 300);
                    }
                    
                    // Auto-test after 300ms
                    setTimeout(() => {
                        testAudioInput();
                    }, 300);
                });
            }

            // 4. Restore History
            if (messageHistory.length > 0) {
                if(welcomeScreen) welcomeScreen.style.display = 'none';
                messageHistory.forEach(msg => renderMessageCard(msg));
                setTimeout(scrollToBottom, 100);
            }

            // 5. Init Core
            initRecognition();
        });

        // --- Audio Input Logic ---
        async function getAudioInputs() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                console.log("enumerateDevices() not supported.");
                return;
            }

            try {
                // Need to ask permission first to see device labels
                await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(device => device.kind === 'audioinput');
                
                if (audioSelect) {
                    audioSelect.innerHTML = '<option value="default">é è¨­è£ç½® (Default)</option>';
                    audioInputs.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.text = device.label || `Microphone ${audioSelect.length + 1}`;
                        audioSelect.appendChild(option);
                    });
                    audioSelect.value = selectedDeviceId;
                }
            } catch (err) {
                console.error("Error getting audio devices: " + err);
            }
        }

        // --- Audio Routing Initialization ---
        async function initAudioRouting() {
            try {
                // Stop existing stream if any
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // Build constraints with critical settings for system audio
                const constraints = { 
                    audio: {
                        deviceId: selectedDeviceId === 'default' ? undefined : { exact: selectedDeviceId },
                        echoCancellation: false,  // ğŸ”´ Critical: Don't cancel system audio
                        noiseSuppression: false,  // ğŸ”´ Critical: Keep all audio
                        autoGainControl: false    // ğŸ”´ Critical: Don't adjust volume
                    }
                };
                
                logDebug(`initAudioRouting with device: ${selectedDeviceId}`, "sys");
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Create audio context for routing
                if (audioContext && audioContext.state !== 'closed') {
                    await audioContext.close();
                }
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create nodes for audio routing
                sourceNode = audioContext.createMediaStreamSource(stream);
                destinationNode = audioContext.createMediaStreamDestination();
                
                // Connect nodes
                sourceNode.connect(destinationNode);
                
                // Also connect to analyser for visualization
                analyser = audioContext.createAnalyser();
                sourceNode.connect(analyser);
                analyser.fftSize = 256;
                
                logDebug("Audio routing initialized successfully", "sys");
                
                return stream;
            } catch (err) {
                logDebug(`initAudioRouting error: ${err.message}`, "error");
                throw err;
            }
        }

        // --- Audio Test Function ---
        function testAudioInput() {
            logDebug("Starting audio test...", "sys");
            
            const statusIndicator = document.getElementById('audio-status-indicator');
            const statusText = document.getElementById('audio-status-text');
            
            // Clear any existing test
            if (audioTestInterval) {
                clearInterval(audioTestInterval);
                audioTestInterval = null;
            }
            
            // Update UI to testing state
            if (statusIndicator) {
                statusIndicator.className = 'audio-status-indicator audio-status-warning blink';
            }
            if (statusText) {
                statusText.textContent = 'æ¸¬è©¦ä¸­...';
            }
            
            // Get audio constraints
            const constraints = { 
                audio: {
                    deviceId: selectedDeviceId === 'default' ? undefined : { exact: selectedDeviceId },
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false
                }
            };
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(testStream => {
                    const testAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const testAnalyser = testAudioContext.createAnalyser();
                    const testSource = testAudioContext.createMediaStreamSource(testStream);
                    testSource.connect(testAnalyser);
                    testAnalyser.fftSize = 256;
                    
                    const bufferLength = testAnalyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    
                    let signalDetected = false;
                    let testCount = 0;
                    let noSignalCount = 0;
                    
                    audioTestInterval = setInterval(() => {
                        testCount++;
                        testAnalyser.getByteFrequencyData(dataArray);
                        
                        // Calculate average signal level
                        const average = dataArray.reduce((a, b) => a + b, 0) / bufferLength;
                        
                        if (average > AUDIO_SIGNAL_THRESHOLD) {
                            signalDetected = true;
                            noSignalCount = 0;
                            
                            // Update status to good
                            if (statusIndicator) {
                                statusIndicator.className = 'audio-status-indicator audio-status-good';
                            }
                            if (statusText) {
                                statusText.textContent = `è¨Šè™Ÿæ­£å¸¸ (${average.toFixed(0)})`;
                            }
                            logDebug(`Audio test: Signal detected (level: ${average.toFixed(0)})`, "sys");
                        } else {
                            noSignalCount++;
                            
                            // Warn after reaching no signal warning threshold
                            if (noSignalCount >= NO_SIGNAL_WARNING_COUNT) {
                                if (statusIndicator) {
                                    statusIndicator.className = 'audio-status-indicator audio-status-error blink';
                                }
                                if (statusText) {
                                    statusText.textContent = 'ç„¡è¨Šè™Ÿï¼è«‹æª¢æŸ¥è£ç½®';
                                }
                                showToast("5ç§’å…§æœªåµæ¸¬åˆ°éŸ³è¨Šè¨Šè™Ÿï¼Œè«‹æª¢æŸ¥è£ç½®è¨­å®š", "error");
                            }
                        }
                        
                        // End test after reaching max test duration
                        if (testCount >= AUDIO_TEST_DURATION) {
                            clearInterval(audioTestInterval);
                            audioTestInterval = null;
                            
                            // Clean up
                            testStream.getTracks().forEach(track => track.stop());
                            testAudioContext.close();
                            
                            // Final status
                            if (signalDetected) {
                                if (statusIndicator) {
                                    statusIndicator.className = 'audio-status-indicator audio-status-good';
                                }
                                if (statusText) {
                                    statusText.textContent = 'æ¸¬è©¦é€šé âœ“';
                                }
                                showToast("éŸ³è¨Šæ¸¬è©¦é€šé", "success");
                                logDebug("Audio test: PASSED", "sys");
                            } else {
                                if (statusIndicator) {
                                    statusIndicator.className = 'audio-status-indicator audio-status-error';
                                }
                                if (statusText) {
                                    statusText.textContent = 'æ¸¬è©¦å¤±æ•— âœ—';
                                }
                                showToast("éŸ³è¨Šæ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥è£ç½®è¨­å®š", "error");
                                logDebug("Audio test: FAILED - No signal detected", "error");
                            }
                        }
                    }, 500);
                })
                .catch(err => {
                    logDebug(`Audio test error: ${err.message}`, "error");
                    if (statusIndicator) {
                        statusIndicator.className = 'audio-status-indicator audio-status-error';
                    }
                    if (statusText) {
                        statusText.textContent = 'ç„¡æ³•å­˜å–è£ç½®';
                    }
                    showToast("ç„¡æ³•å­˜å–éŸ³è¨Šè£ç½®", "error");
                });
        }

        // --- Start/Stop Recognition helpers ---
        function startRecognition() {
            if (!recognition) initRecognition();
            try {
                recognition.lang = currentLang;
                recognition.start();
            } catch (e) {
                logDebug(`startRecognition error: ${e.message}`, "error");
            }
        }

        function stopRecognition() {
            try {
                isListening = false;
                ignoreEnd = true;
                restartAttempts = 0;
                if (recognition) {
                    recognition.stop();
                }
                updateMicState(false);
            } catch (e) {
                logDebug(`stopRecognition error: ${e.message}`, "error");
            }
        }

        // --- Helper Functions ---

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            const txt = document.getElementById('toast-msg');
            const icon = document.getElementById('toast-icon');
            if(!t || !txt || !icon) return;
            
            txt.innerText = msg;
            icon.className = type === 'error' ? "fa-solid fa-circle-exclamation" : "fa-solid fa-check";
            t.className = `fixed top-4 left-0 right-0 z-[90] flex justify-center pointer-events-auto transform translate-y-0 opacity-100 transition-all duration-300`;
            t.firstElementChild.className = type === 'error' ? "bg-red-50 border border-red-200 text-red-600 px-6 py-3 rounded-full shadow-lg flex items-center gap-3" : "bg-emerald-50 border border-emerald-200 text-emerald-600 px-6 py-3 rounded-full shadow-lg flex items-center gap-3";
            setTimeout(() => { t.classList.remove('translate-y-0', 'opacity-100'); t.classList.add('-translate-y-full', 'opacity-0'); }, 2000);
        }

        function toggleModal(id) {
            const modal = document.getElementById(id);
            if(!modal) return;
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }, 10);
            } else {
                modal.classList.add('opacity-0'); modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function toggleSettings() { toggleModal('settings-modal'); }
        function toggleClearModal() { toggleModal('clear-modal'); }
        function toggleAudioHelp() { toggleModal('audio-help-modal'); }
        function toggleSummaryModal() { toggleModal('summary-modal'); renderPromptList(); if (allPrompts.length > 0 && !currentPromptId) selectPrompt(allPrompts[0].id); }

        function saveToLocalStorage() { localStorage.setItem('vibe_history', JSON.stringify(messageHistory)); }

        function copyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if(successful) showToast("å·²è¤‡è£½", "success");
                else showToast("è¤‡è£½å¤±æ•—", "error");
            } catch (err) {
                console.error('Copy failed', err); showToast("è¤‡è£½å¤±æ•—", "error");
            }
            document.body.removeChild(textArea);
        }

        function logDebug(msg, type = "raw") {
            if (!isDebugMode) return;
            if(!debugContent) return;
            const time = new Date().toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute:'2-digit', second:'2-digit'});
            const div = document.createElement('div');
            div.className = `debug-line log-${type}`;
            div.innerHTML = `<span class="opacity-50 mr-2">[${time}]</span>${msg}`;
            debugContent.insertBefore(div, debugContent.firstChild);
            if(debugContent.children.length > 50) debugContent.lastChild.remove();
        }

        function clearDebugLog() { if(debugContent) debugContent.innerHTML = ''; }
        function copyDebugLog() { if (debugContent) copyTextToClipboard(debugContent.innerText); }

        // --- Business Logic ---

        function toggleAI(checked) {
            isAIEnabled = checked;
            if(aiToggle) aiToggle.checked = checked;
            if(aiToggleSettings) aiToggleSettings.checked = checked;
            
            if(isAIEnabled && !apiKey) {
                showToast("è«‹å…ˆè¨­å®š API Key", "error");
                toggleSettings();
                isAIEnabled = false;
                if(aiToggle) aiToggle.checked = false;
                if(aiToggleSettings) aiToggleSettings.checked = false;
            }
        }

        function saveSettings() {
            if(apiKeyInput) {
                apiKey = apiKeyInput.value.trim();
                localStorage.setItem('vibe_gemini_api_key', apiKey);
                showToast("è¨­å®šå·²å„²å­˜", "success");
                toggleSettings();
            }
        }

        function updateDebugUI() {
            if(isDebugMode) {
                if(debugPanel) debugPanel.classList.remove('hidden');
                if(micContainer) micContainer.style.bottom = '13.5rem'; 
            } else {
                if(debugPanel) debugPanel.classList.add('hidden');
                if(micContainer) micContainer.style.bottom = '1.5rem';
            }
        }

        function toggleDebugPanel() {
            isDebugMode = !isDebugMode;
            if(debugToggle) debugToggle.checked = isDebugMode;
            updateDebugUI();
        }

        function startVisualizer(deviceId = 'default') {
            if (!navigator.mediaDevices.getUserMedia || !canvas || !canvasCtx) return;
            
            // Stop previous stream if any
            if(stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            // Use selected device for visualizer with optimized constraints
            const constraints = { 
                audio: deviceId === 'default' ? {
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false
                } : { 
                    deviceId: { exact: deviceId },
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false
                } 
            };

            navigator.mediaDevices.getUserMedia(constraints)
                .then(newStream => {
                    stream = newStream;
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    microphone = audioContext.createMediaStreamSource(stream);
                    
                    // Also create routing nodes for shared audio stream
                    sourceNode = microphone;
                    destinationNode = audioContext.createMediaStreamDestination();
                    sourceNode.connect(destinationNode);
                    
                    microphone.connect(analyser);
                    analyser.fftSize = 256;
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    canvas.width = 100;
                    canvas.height = 30;

                    function draw() {
                        if(!isListening) {
                            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
                            return;
                        }
                        requestAnimationFrame(draw);
                        analyser.getByteFrequencyData(dataArray);
                        canvasCtx.fillStyle = '#f1f5f9';
                        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
                        const barWidth = (canvas.width / bufferLength) * 2.5;
                        let barHeight;
                        let x = 0;
                        for(let i = 0; i < bufferLength; i++) {
                            barHeight = dataArray[i] / 2;
                            canvasCtx.fillStyle = currentMode === 'meeting' ? '#3b82f6' : '#10b981';
                            canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                            x += barWidth + 1;
                        }
                    }
                    draw();
                    logDebug("Visualizer started with optimized audio constraints", "sys");
                })
                .catch(err => {
                    logDebug(`Visualizer error: ${err.message}`, "error");
                    console.log('Visualizer error:', err);
                });
        }

        function changeMode(mode) {
            currentMode = mode;
            logDebug(`Mode changed to: ${mode}`, "sys");
            
            if (mode === 'meeting') {
                if(appLogo) {
                    appLogo.classList.replace('bg-emerald-500', 'bg-blue-600');
                    appLogo.classList.replace('shadow-emerald-200', 'shadow-blue-200');
                }
                if(modeSelect) modeSelect.classList.replace('text-emerald-600', 'text-blue-600');
                if(welcomeIcon) welcomeIcon.className = "fa-solid fa-users text-6xl mb-4 opacity-50 transition-opacity";
                if(welcomeText) welcomeText.innerText = "æº–å‚™å¥½é–‹æœƒäº†å—ï¼Ÿ";
                
                if (isListening && micBtn && micStatus) {
                    micBtn.classList.replace('bg-emerald-500', 'bg-blue-600');
                    micStatus.className = micStatus.className.replace('text-emerald-400', 'text-blue-400');
                }
            } else {
                if(appLogo) {
                    appLogo.classList.replace('bg-blue-600', 'bg-emerald-500');
                    appLogo.classList.replace('shadow-blue-200', 'shadow-emerald-200');
                }
                if(modeSelect) modeSelect.classList.replace('text-blue-600', 'text-emerald-600');
                if(welcomeIcon) welcomeIcon.className = "fa-solid fa-chalkboard-user text-6xl mb-4 opacity-50 transition-opacity";
                if(welcomeText) welcomeText.innerText = "æº–å‚™å¥½ä¸Šèª²äº†å—ï¼Ÿ";
                
                if (isListening && micBtn && micStatus) {
                    micBtn.classList.replace('bg-blue-600', 'bg-emerald-500');
                    micStatus.className = micStatus.className.replace('text-blue-400', 'text-emerald-400');
                }
            }
        }

        function renderPromptList() {
            const list = document.getElementById('prompt-list');
            if(!list) return;
            list.innerHTML = '';
            allPrompts.forEach(p => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors mb-1 ${currentPromptId === p.id ? 'bg-indigo-100 text-indigo-700' : 'text-slate-600 hover:bg-slate-100'}`;
                btn.innerHTML = p.title;
                btn.onclick = () => selectPrompt(p.id);
                list.appendChild(btn);
            });
        }

        function selectPrompt(id) {
            currentPromptId = id;
            renderPromptList();
            const prompt = allPrompts.find(p => p.id === id);
            if (prompt) {
                const t = document.getElementById('prompt-title');
                const c = document.getElementById('prompt-content');
                if(t) t.value = prompt.title;
                if(c) c.value = prompt.content;
            }
        }

        function addNewPrompt() {
            const newId = `custom-${Date.now()}`;
            const newPrompt = { id: newId, title: 'æ–°æç¤ºè©', content: '' };
            customPrompts.push(newPrompt);
            allPrompts = [...defaultPrompts, ...customPrompts];
            localStorage.setItem('vibe_prompts', JSON.stringify(customPrompts));
            selectPrompt(newId);
        }

        function saveCurrentPrompt() {
            if (!currentPromptId) return;
            const title = document.getElementById('prompt-title').value;
            const content = document.getElementById('prompt-content').value;
            
            if (defaultPrompts.some(p => p.id === currentPromptId)) {
                const newId = `custom-${Date.now()}`;
                const newPrompt = { id: newId, title: title, content: content };
                customPrompts.push(newPrompt);
                localStorage.setItem('vibe_prompts', JSON.stringify(customPrompts));
                allPrompts = [...defaultPrompts, ...customPrompts];
                selectPrompt(newId);
                showToast("å·²å¦å­˜ç‚ºæ–°æ¨¡æ¿", "success");
                return;
            }
            const idx = customPrompts.findIndex(p => p.id === currentPromptId);
            if (idx !== -1) {
                customPrompts[idx].title = title;
                customPrompts[idx].content = content;
                localStorage.setItem('vibe_prompts', JSON.stringify(customPrompts));
                allPrompts = [...defaultPrompts, ...customPrompts];
                renderPromptList();
                showToast("å„²å­˜æˆåŠŸ", "success");
            }
        }

        function deleteCurrentPrompt() {
            if (!currentPromptId) return;
            if (defaultPrompts.some(p => p.id === currentPromptId)) { showToast("ç„¡æ³•åˆªé™¤é è¨­æ¨¡æ¿", "error"); return; }
            if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤æç¤ºè©å—ï¼Ÿ")) return;
            customPrompts = customPrompts.filter(p => p.id !== currentPromptId);
            localStorage.setItem('vibe_prompts', JSON.stringify(customPrompts));
            allPrompts = [...defaultPrompts, ...customPrompts];
            selectPrompt(allPrompts[0].id);
        }

        async function generateSummary() {
            if (!apiKey) { showToast("è«‹å…ˆè¨­å®š API Key", "error"); return; }
            if (messageHistory.length === 0) { showToast("æ²’æœ‰å…§å®¹å¯ç¸½çµ", "error"); return; }

            const promptText = document.getElementById('prompt-content').value;
            const fullTranscript = messageHistory.map(m => {
                let text = m.original;
                if (m.translation && !m.translation.includes('<div')) {
                    text += ` (${m.translation})`;
                }
                return text;
            }).join("\n");

            const finalPrompt = `${promptText}\n\n[Transcript Content]:\n${fullTranscript}`;
            
            const loading = document.getElementById('summary-loading');
            const result = document.getElementById('summary-result');
            const actions = document.getElementById('summary-actions');

            if(loading) loading.classList.remove('hidden');
            if(result) result.innerHTML = '';
            if(actions) actions.classList.add('hidden');

            try {
                const apiURL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: finalPrompt }] }] };
                
                const res = await fetch(apiURL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();
                if (data.candidates && data.candidates[0].content) {
                    const md = data.candidates[0].content.parts[0].text;
                    if(result) result.innerHTML = marked.parse(md);
                    if(actions) actions.classList.remove('hidden');
                } else {
                    throw new Error("No summary generated");
                }
            } catch (e) {
                console.error(e);
                showToast("ç¸½çµå¤±æ•—: " + e.message, "error");
                if(result) result.innerHTML = `<p class="text-red-500">ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯é€£ç·šã€‚</p>`;
            } finally {
                if(loading) loading.classList.add('hidden');
            }
        }

        function copySummary() {
            const result = document.getElementById('summary-result');
            if(result) copyTextToClipboard(result.innerText);
        }

        function renderMessageCard(msg) {
            if(!msgContainer) return;
            const div = document.createElement('div');
            div.id = msg.id;
            div.className = "msg-card bg-white p-4 md:p-5 rounded-2xl shadow-sm border border-slate-100 transition-all hover:shadow-md";
            
            let translationBlock = '';
            if (msg.isAI || msg.translation) {
                let content = msg.translation || '<span class="inline-block h-4 w-24 rounded shimmer bg-slate-100"></span>';
                let iconClass = "fa-solid fa-language";
                let iconBg = "bg-emerald-100 text-emerald-600";
                
                if (msg.mode === 'meeting' || (content.includes('ğŸ”´') || content.includes('Action'))) {
                    iconClass = "fa-solid fa-list-check";
                    iconBg = "bg-blue-100 text-blue-600";
                }

                translationBlock = `
                    <div class="mt-3 pt-3 border-t border-slate-100 flex gap-3 items-start">
                        <div class="mt-1 w-5 h-5 rounded-full ${iconBg} flex items-center justify-center shrink-0 text-xs"><i class="${iconClass}"></i></div>
                        <div class="flex-1"><div class="translation-content text-slate-700 font-medium text-lg leading-relaxed ${content.includes('<div') ? '' : (msg.mode === 'meeting' ? 'text-blue-900' : 'text-emerald-800')}">${content}</div></div>
                    </div>`;
            }

            div.innerHTML = `
                <div class="flex gap-3 items-start">
                    <div class="mt-1 w-5 h-5 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center shrink-0 text-xs"><i class="fa-solid fa-quote-left"></i></div>
                    <div class="flex-1"><p class="original-text text-slate-500 text-base md:text-lg">${msg.original}</p></div>
                    <button onclick="copyCard('${msg.id}')" class="text-slate-300 hover:text-emerald-500 transition-colors"><i class="fa-regular fa-copy"></i></button>
                </div>
                ${translationBlock}
            `;
            msgContainer.appendChild(div);
        }

        function createMessageCard(text, isFinal) {
            if(welcomeScreen) welcomeScreen.style.display = 'none';
            const id = `msg-${Date.now()}`;
            const newMsg = { 
                id, original: text, translation: '', isAI: isAIEnabled, timestamp: Date.now(), mode: currentMode 
            };
            messageHistory.push(newMsg);
            saveToLocalStorage();
            renderMessageCard(newMsg);
            scrollToBottom();
            if (isAIEnabled) translateMessage(id, text);
        }

        async function translateMessage(id, text) {
            if (!apiKey) return;
            try {
                const lastMsg = messageHistory.length >= 2 ? messageHistory[messageHistory.length - 2] : null;
                const context = lastMsg ? (lastMsg.original + " " + (lastMsg.translation || "")) : "None";
                logDebug(`AI Request (${currentMode})`, "sys");
                const result = await callGeminiAPI(text, context);
                updateTranslation(id, result);
                logDebug("AI Response Received", "ai");
            } catch (error) {
                console.error(error);
                logDebug(`AI Error: ${error.message}`, "error");
                const errorHtml = `<div class="flex items-center gap-2 text-amber-500 text-sm font-bold bg-amber-50 px-3 py-2 rounded-lg w-fit"><i class="fa-solid fa-triangle-exclamation"></i><span>ç¿»è­¯æœªå®Œæˆ</span><button onclick="retryTranslation('${id}')" class="ml-auto bg-white border border-amber-200 text-amber-600 hover:text-amber-800 px-2 py-0.5 rounded text-xs transition-colors shadow-sm">é‡è©¦</button></div>`;
                updateTranslation(id, errorHtml);
            }
        }

        function retryTranslation(id) {
            const card = document.getElementById(id);
            if(!card) return;
            const text = card.querySelector('.original-text').innerText;
            const transDiv = card.querySelector('.translation-content');
            if(transDiv) transDiv.innerHTML = '<span class="inline-block h-4 w-24 rounded shimmer bg-slate-100"></span>';
            translateMessage(id, text);
        }

        function updateTranslation(id, content) {
            const card = document.getElementById(id);
            if (!card) return;
            const contentDiv = card.querySelector('.translation-content');
            if (contentDiv) {
                contentDiv.innerHTML = content;
                if (!content.includes('<div')) {
                    if (currentMode === 'meeting') {
                        contentDiv.classList.remove('text-emerald-800');
                        contentDiv.classList.add('text-blue-900');
                    } else {
                        contentDiv.classList.remove('text-blue-900');
                        contentDiv.classList.add('text-emerald-800');
                    }
                }
            }
            const msg = messageHistory.find(m => m.id === id);
            if(msg && !content.includes('<div')) {
                msg.translation = content;
                saveToLocalStorage();
            }
        }

        async function callGeminiAPI(text, context) {
            const apiURL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            let prompt = "";
            
            if (currentMode === 'lecture') {
                if (currentLang === 'en-US') {
                    prompt = `Role: Expert Academic Interpreter. Context: "${context}" Input (Noisy ASR): "${text}" Task: 1. Fix phonetic errors based on context. 2. Translate to Fluent Traditional Chinese (Taiwan). Output: "Original (Fixed): [Fixed English]<br><br>[Chinese Translation]"`;
                } else {
                    prompt = `Role: Expert Interpreter. Context: "${context}" Input: "${text}" Task: Fix errors, Translate to English. Output: "Original (Fixed): [Fixed Chinese]<br><br>[English Translation]"`;
                }
            } else {
                prompt = `Role: Professional Meeting Minute Taker. Context: "${context}" Input (Raw Mixed Audio Transcript): "${text}" Task: 1. Code-Switching Repair. 2. Identify Intent. 3. Mark Action Items with ğŸ”´. 4. Output in Traditional Chinese (Taiwan). Output Format: "[Intent/Speaker Guess]: [Polished Content] <br> [ğŸ”´ Action Item if any]"`;
            }

            const payload = { 
                contents: [{ parts: [{ text: prompt }] }],
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                ]
            };

            const maxRetries = 3; 
            for(let i=0; i <= maxRetries; i++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);
                    const res = await fetch(apiURL, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload), signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    if (res.status === 503) throw new Error("503");
                    if (!res.ok) throw new Error(`API Error: ${res.status}`);
                    const data = await res.json();
                    if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts.length > 0) return data.candidates[0].content.parts[0].text.trim();
                    throw new Error("No Content");
                } catch(e) {
                    if(i === maxRetries) throw e; 
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i)));
                }
            }
        }

        function exportHistory() {
            if (messageHistory.length === 0) { showToast("ç„¡å…§å®¹", "error"); return; }
            let mdContent = "# Vibe Note\n\n";
            messageHistory.forEach((msg, i) => {
                mdContent += `### ${i + 1}. ${msg.original}\n> ${msg.translation || ''}\n\n`;
            });
            const url = URL.createObjectURL(new Blob([mdContent], { type: 'text/markdown' }));
            const a = document.createElement('a'); a.href = url; a.download = `Vibe_${Date.now()}.md`;
            a.click(); URL.revokeObjectURL(url);
            showToast("å·²åŒ¯å‡º", "success");
        }

        function copyCard(id) { 
            const el = document.getElementById(id);
            if(el) copyTextToClipboard(el.innerText);
        }

        function clearAll() { if (messageHistory.length > 0) toggleClearModal(); }
        function performClear() { 
            if(msgContainer) msgContainer.innerHTML = ''; 
            // Safe check for welcomeScreen again in clear function
            const ws = document.getElementById('welcome-screen');
            if(ws) ws.style.display = 'flex'; 
            messageHistory = []; 
            localStorage.removeItem('vibe_history'); 
            toggleClearModal(); 
            showToast("å·²æ¸…ç©º", "success"); 
            logDebug("History Cleared", "sys"); 
        }

        function scrollToBottom() { if(msgContainer) msgContainer.scrollTop = msgContainer.scrollHeight; }

        function setLanguage(lang) {
            currentLang = lang;
            const btnEn = document.getElementById('lang-en');
            const btnZh = document.getElementById('lang-zh');
            const activeClass = "bg-white text-emerald-700 shadow-sm border border-slate-200";
            const inactiveClass = "text-slate-500 hover:text-slate-700 border border-transparent";
            
            if(lang === 'en-US') {
                if(btnEn) btnEn.className = `px-4 py-1 rounded-full text-xs font-bold transition-all ${activeClass}`;
                if(btnZh) btnZh.className = `px-4 py-1 rounded-full text-xs font-bold transition-all ${inactiveClass}`;
            } else {
                if(btnZh) btnZh.className = `px-4 py-1 rounded-full text-xs font-bold transition-all ${activeClass}`;
                if(btnEn) btnEn.className = `px-4 py-1 rounded-full text-xs font-bold transition-all ${inactiveClass}`;
            }

            if(isListening) {
                logDebug(`Switching Lang to ${lang}`, "sys");
                ignoreEnd = true; recognition.stop();
                setTimeout(() => { ignoreEnd = false; recognition.lang = lang; recognition.start(); }, 300);
            }
        }

        function updateMicState(on) {
            const micBtn = document.getElementById('mic-btn');
            if(!micBtn) return;
            const icon = micBtn.querySelector('i');
            // Safe grab inside function
            const micStatus = document.getElementById('mic-status');
            const interimBar = document.getElementById('interim-bar');
            const recDot = document.getElementById('recording-dot');

            const activeColor = currentMode === 'meeting' ? 'bg-blue-600' : 'bg-emerald-500';
            const activeText = currentMode === 'meeting' ? 'text-blue-400' : 'text-emerald-400';

            if (on) {
                micBtn.classList.remove('bg-slate-800');
                micBtn.classList.add(activeColor);
                micBtn.classList.add('mic-active');
                if(recDot) recDot.classList.remove('hidden');
                if(icon) icon.classList.replace('fa-microphone', 'fa-pause');
                if(interimBar) interimBar.classList.remove('opacity-0', 'translate-y-4');
                if(micStatus) {
                    micStatus.textContent = "Listening...";
                    micStatus.className = `text-xs font-mono tracking-wider uppercase shrink-0 ${activeText} animate-pulse`;
                }
            } else {
                micBtn.classList.add('bg-slate-800');
                micBtn.classList.remove('bg-emerald-500', 'bg-blue-600');
                micBtn.classList.remove('mic-active');
                if(recDot) recDot.classList.add('hidden');
                if(icon) icon.classList.replace('fa-pause', 'fa-microphone');
                if(interimBar) interimBar.classList.add('opacity-0', 'translate-y-4');
            }
        }

        function toggleRecognition() {
            if (!recognition) initRecognition();
            try {
                if (isListening) { 
                    stopRecognition();
                } else { 
                    restartAttempts = 0;
                    recognition.lang = currentLang; 
                    recognition.start(); 
                }
            } catch (e) {
                console.error("Toggle recognition error", e);
                logDebug("Toggle Error: " + e.message, "error");
                isListening = false;
                restartAttempts = 0;
                updateMicState(false);
            }
        }

        function initRecognition() {
            if (!('webkitSpeechRecognition' in window)) { showToast("è«‹ä½¿ç”¨ Chrome", "error"); return; }
            recognition = new webkitSpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = currentLang;
            recognition.maxAlternatives = 3; 

            recognition.onstart = () => {
                isListening = true; ignoreEnd = false; updateMicState(true);
                restartAttempts = 0; // Reset counter on successful start
                logDebug("Recognition started successfully", "sys");
                
                lastResultTime = Date.now();
                pendingInterim = '';
                lastInterimLength = 0;
                
                if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(()=>{});
                startVisualizer(selectedDeviceId);

                clearInterval(silenceInterval);
                silenceInterval = setInterval(() => {
                    if (isListening && (Date.now() - lastResultTime > SILENCE_TIMEOUT)) {
                        logDebug("Long silence detected", "sys");
                        const ms = document.getElementById('mic-status');
                        if(ms) {
                            ms.textContent = "Check Mic!";
                            ms.className = "text-xs font-mono tracking-wider uppercase shrink-0 text-amber-500 font-bold blink";
                        }
                    }
                }, 5000);
            };

            recognition.onend = () => {
                clearInterval(silenceInterval);
                
                if (pendingInterim && pendingInterim.trim().length > 5) {
                    logDebug(`Committing on end: "${pendingInterim}"`, "sys");
                    createMessageCard(pendingInterim.trim(), true);
                    pendingInterim = '';
                    // Safe check for interimText
                    const iText = document.getElementById('interim-text');
                    if(iText) iText.innerText = '...';
                }

                if (isListening && !ignoreEnd) {
                    restartAttempts++;
                    logDebug(`Recognition ended. Restart attempt ${restartAttempts}/${MAX_RESTART_ATTEMPTS}`, "sys");
                    
                    // Check if max retries exceeded
                    if (restartAttempts > MAX_RESTART_ATTEMPTS) {
                        showToast("èªéŸ³è¾¨è­˜å¤šæ¬¡ä¸­æ–·ï¼Œè«‹æª¢æŸ¥éŸ³è¨Šä¾†æº", "error");
                        logDebug("Max restart attempts exceeded. Stopping.", "error");
                        stopRecognition();
                        return;
                    }
                    
                    // Increased delay from 100ms to 500ms for stability
                    setTimeout(() => {
                        try {
                            recognition.start();
                        } catch (err) {
                            logDebug(`Restart failed: ${err.message}`, "error");
                            restartAttempts++;
                        }
                    }, 500);
                } else {
                    isListening = false; updateMicState(false);
                    restartAttempts = 0;
                    logDebug("Recognition Stopped", "sys");
                    // Direct access for safety
                    const ms = document.getElementById('mic-status');
                    if(ms) {
                        ms.textContent = "Stopped";
                        ms.className = "text-[10px] text-slate-400 font-mono tracking-wider uppercase shrink-0";
                    }
                }
            };

            recognition.onresult = (event) => {
                lastResultTime = Date.now();
                let interim = '';
                let final = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const result = event.results[i];
                    if (result.isFinal) {
                        let bestTranscript = result[0].transcript;
                        let bestConfidence = result[0].confidence;
                        for (let j = 1; j < Math.min(result.length, 3); j++) {
                            if (result[j] && result[j].confidence > bestConfidence) {
                                bestTranscript = result[j].transcript;
                                bestConfidence = result[j].confidence;
                            }
                        }
                        final += bestTranscript;
                        logDebug(`Final (conf: ${bestConfidence.toFixed(2)}): "${bestTranscript}"`, "final");
                    } else {
                        interim += result[0].transcript;
                    }
                }

                // Direct access for safety
                const iText = document.getElementById('interim-text');
                const mStatus = document.getElementById('mic-status');

                if (final.trim()) {
                    const cleanFinal = final.trim();
                    const isDup = lastFinalText && (cleanFinal === lastFinalText || cleanFinal.includes(lastFinalText) || lastFinalText.includes(cleanFinal));
                    
                    if (!isDup || (Date.now() - (messageHistory[messageHistory.length-1]?.timestamp || 0) > 3000)) {
                        createMessageCard(cleanFinal, true);
                        lastFinalText = cleanFinal;
                    } else {
                        logDebug("Ignored duplicate final", "sys");
                    }
                    pendingInterim = '';
                    if(iText) iText.innerText = '...';
                    if(mStatus) mStatus.textContent = "Listening...";
                }

                if (interim.trim()) {
                    const cleanInterim = interim.trim();
                    
                    if (cleanInterim.length > lastInterimLength * 0.3) { 
                        pendingInterim = cleanInterim;
                        if(iText) iText.innerText = cleanInterim;
                        if(mStatus) mStatus.textContent = "Transcribing...";
                        logDebug(`Interim: "${cleanInterim}"`, "raw");
                        lastInterimLength = cleanInterim.length;
                        
                        if (cleanInterim.length > 200) {
                            logDebug("Force commit (Length > 200) & STOP", "sys");
                            createMessageCard(cleanInterim, true);
                            
                            lastFinalText = cleanInterim; 
                            pendingInterim = ''; 
                            recognition.stop(); 
                            return; 
                        }
                    }
                }
            };

            recognition.onerror = (event) => {
                logDebug(`Recognition error: ${event.error}`, "error");
                
                if (event.error === 'not-allowed') {
                    showToast("éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•", "error"); 
                    ignoreEnd = true; 
                    isListening = false; 
                    updateMicState(false);
                } else if (event.error === 'audio-capture') {
                    showToast("ç„¡æ³•æ•æ‰éŸ³è¨Šï¼Œè«‹æª¢æŸ¥è£ç½®æ¬Šé™", "error");
                    logDebug("Audio capture failed - check device permissions", "error");
                    stopRecognition();
                } else if (event.error === 'network') {
                    showToast("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·š", "error");
                    logDebug("Network error - check connection", "error");
                } else if (event.error === 'no-speech') {
                    // Only show toast after multiple no-speech events
                    logDebug("No speech detected, continuing...", "sys");
                    const ms = document.getElementById('mic-status');
                    if (ms) {
                        ms.textContent = "ç„¡èªéŸ³...";
                        ms.className = "text-xs font-mono tracking-wider uppercase shrink-0 text-amber-500";
                    }
                } else if (event.error === 'aborted') {
                    logDebug("Recognition aborted", "sys");
                } else if (event.error === 'service-not-allowed') {
                    showToast("èªéŸ³æœå‹™ä¸å¯ç”¨", "error");
                    logDebug("Speech service not allowed", "error");
                }
            };
        }
    </script>
</body>
</html>
